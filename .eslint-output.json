[{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\app\\api\\webhooks\\ads\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4761,4764],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4761,4764],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\n// Utilizando service_role_key para o backend poder dar bypass no RLS e inserir/atualizar\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\nconst supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\ninterface WebhookPayload {\r\n    google_ads_account_id: string; // ID oriundo do Ads Script para ligar a conta\r\n    account_name?: string;         // Opcional, nome da conta\r\n    campaign_name: string;\r\n    budget?: number;\r\n    status?: string;\r\n    impressions?: number;\r\n    clicks: number;\r\n    cost: number;\r\n    conversions?: number;\r\n    conversion_value: number;\r\n    search_absolute_top_impression_share?: number;\r\n    search_top_impression_share?: number;\r\n    search_impression_share?: number;\r\n    target_cpa?: number;\r\n    avg_target_cpa?: number;\r\n    date: string; // YYYY-MM-DD\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        // 1. Validar a API_KEY do header\r\n        const apiKey = req.headers.get('x-api-key');\r\n        if (!apiKey || apiKey !== process.env.WEBHOOK_API_KEY) {\r\n            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n        }\r\n\r\n        // 2. Fazer o parse do payload recebido do Google Ads Script\r\n        const data: WebhookPayload = await req.json();\r\n\r\n        if (!data.google_ads_account_id || !data.campaign_name || !data.date) {\r\n            return NextResponse.json({ error: 'Faltam campos essenciais no payload' }, { status: 400 });\r\n        }\r\n\r\n        // 3. Garantir que a Conta (Account) existe. Se não, criar\r\n        const { data: accountData, error: accountError } = await supabaseAdmin\r\n            .from('accounts')\r\n            .select('id')\r\n            .eq('google_ads_account_id', data.google_ads_account_id)\r\n            .single();\r\n\r\n        let accountId = accountData?.id;\r\n\r\n        if (accountError && accountError.code === 'PGRST116') { // PGRST116: Nenhum registro retornado\r\n            const { data: newAccount, error: createError } = await supabaseAdmin\r\n                .from('accounts')\r\n                .insert({\r\n                    google_ads_account_id: data.google_ads_account_id,\r\n                    name: data.account_name || `Conta - ${data.google_ads_account_id}`,\r\n                })\r\n                .select('id')\r\n                .single();\r\n\r\n            if (createError) throw createError;\r\n            accountId = newAccount.id;\r\n        } else if (accountError) {\r\n            throw accountError;\r\n        }\r\n\r\n        // 4. Calcular O Lucro (Profit) Internamente e tratar números\r\n        const cost = Number(data.cost) || 0;\r\n        const conversion_value = Number(data.conversion_value) || 0;\r\n        const profit = conversion_value - cost;\r\n        const clicks = Number(data.clicks) || 0;\r\n\r\n        // 5. Inserir ou Sobrescrever os dados no BD\r\n        // Utiliza a chave primária UPSERT baseada na UNIQUE(account_id, campaign_name, date)\r\n        const { error: insertError } = await supabaseAdmin\r\n            .from('campaign_metrics')\r\n            .upsert({\r\n                account_id: accountId,\r\n                campaign_name: data.campaign_name,\r\n                budget: data.budget ? Number(data.budget) : 0,\r\n                status: data.status || 'UNKNOWN',\r\n                impressions: data.impressions ? Number(data.impressions) : 0,\r\n                clicks: clicks,\r\n                cost: cost,\r\n                conversions: data.conversions ? Number(data.conversions) : 0,\r\n                conversion_value: conversion_value,\r\n                profit: profit,\r\n                search_absolute_top_impression_share: data.search_absolute_top_impression_share ? Number(data.search_absolute_top_impression_share) : 0,\r\n                search_top_impression_share: data.search_top_impression_share ? Number(data.search_top_impression_share) : 0,\r\n                search_impression_share: data.search_impression_share ? Number(data.search_impression_share) : 0,\r\n                target_cpa: data.target_cpa ? Number(data.target_cpa) : 0,\r\n                avg_target_cpa: data.avg_target_cpa ? Number(data.avg_target_cpa) : 0,\r\n                date: data.date,\r\n            }, {\r\n                onConflict: 'account_id,campaign_name,date',\r\n                ignoreDuplicates: false // Precisamos atualizar valores, não ignorar\r\n            });\r\n\r\n        if (insertError) throw insertError;\r\n\r\n        // Retorna string ou json de sucesso pro script. Devolver o Profit calculado pode ser um bônus de log no Google\r\n        return NextResponse.json({ success: true, profit }, { status: 200 });\r\n\r\n    } catch (error: any) {\r\n        console.error('Webhook Error:', error.message);\r\n        return NextResponse.json({ error: 'Internal Server Error', details: error.message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\components\\DashboardFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\components\\MetricHeaderCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\components\\ProfitTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Vinicius\\Desktop\\_Desktop_Organizado\\antigravity-skills\\antigravity-kit\\adsmaster-dashboard\\utils\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
